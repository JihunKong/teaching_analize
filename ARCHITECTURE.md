# 시스템 아키텍처

## 전체 시스템 구조

```
┌─────────────────────────────────────────────────────────────┐
│                      Web Interface                           │
│              (React or Streamlit Frontend)                   │
└─────────────────────────────────────────────────────────────┘
                            ↓ ↑
┌─────────────────────────────────────────────────────────────┐
│                    API Gateway (FastAPI)                     │
│  - 파일 업로드   - 작업 상태 조회   - 리포트 다운로드      │
└─────────────────────────────────────────────────────────────┘
                            ↓ ↑
┌─────────────────────────────────────────────────────────────┐
│                    Processing Pipeline                       │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  Module 1    │→ │  Module 2    │→ │  Module 3    │     │
│  │  전사·분리   │  │  분석 엔진   │  │  평가·코칭   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                              ↓               │
│                                    ┌──────────────┐         │
│                                    │  Module 4    │         │
│                                    │  리포트 생성 │         │
│                                    └──────────────┘         │
└─────────────────────────────────────────────────────────────┘
                            ↓ ↑
┌─────────────────────────────────────────────────────────────┐
│                   Data Storage Layer                         │
│  - PostgreSQL (메타데이터)  - File Storage (영상/PDF)       │
└─────────────────────────────────────────────────────────────┘
```

## 모듈별 상세 구조

### Module 1: 전사 및 화자 분리

```
입력: 수업 영상 파일 (.mp4, .avi, .mov)
출력: 교사 발화 타임라인 (JSON)

┌─────────────────────────────────────────┐
│         Audio Extraction                │
│  - FFmpeg로 영상에서 오디오 추출       │
│  - 16kHz, mono 변환                     │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│      Speaker Diarization                │
│  - Pyannote.audio 3.1                   │
│  - 화자별 세그먼트 식별                 │
│  - SPEAKER_00, SPEAKER_01, ...          │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│      Speech Recognition                 │
│  - WhisperX (large-v3)                  │
│  - 한국어 전사                          │
│  - 단어 수준 타임스탬프                 │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│    Speaker-Text Alignment               │
│  - 전사 결과와 화자 정보 결합           │
│  - 세그먼트별 speaker 태깅              │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│    Teacher Identification               │
│  - 발화 시간 비율 분석                  │
│  - 평균 발화 길이 분석                  │
│  - 교사 화자 자동 식별                  │
│  - 신뢰도 검증 (60-90% 규칙)            │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│    Text Preprocessing                   │
│  - 간투사 제거 ("어", "음")             │
│  - 띄어쓰기 정규화                      │
│  - 문장 경계 보정                       │
└─────────────────────────────────────────┘
              ↓
        JSON Output
```

**핵심 기술**
- WhisperX: 전사 + 화자 분리 통합
- FFmpeg: 영상 처리
- KoNLPy: 한국어 형태소 분석

**성능 지표**
- 전사 정확도: 95%+
- 화자 분리 정확도: 95%+ (DER < 5%)
- 처리 속도: 45분 수업 → 약 15-20분 (GPU 사용 시)

---

### Module 2: 3차원 매트릭스 분석

```
입력: 교사 발화 타임라인 (JSON)
출력: 3D 분석 매트릭스 (15×5 행렬)

┌─────────────────────────────────────────┐
│   Phase 1: 수업 단계 세그멘테이션       │
│                                         │
│   각 발화에 대해 이진 체크리스트 실행:  │
│   □ 도입 신호 체크 (5개 항목)          │
│   □ 전개 신호 체크 (5개 항목)          │
│   □ 정리 신호 체크 (5개 항목)          │
│                                         │
│   → 체크 합계 점수로 단계 결정          │
│   → 시간 순서 강제 (도입→전개→정리)    │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│   Phase 2: 교수학적 맥락 태깅           │
│                                         │
│   각 발화를 다중 태그로 분류:           │
│   - [A] 설명형 (4개 하위 체크)         │
│   - [B] 질문형 (5개 하위 체크)         │
│   - [C] 피드백형 (4개 하위 체크)       │
│   - [D] 촉진형 (4개 하위 체크)         │
│   - [E] 관리형 (3개 하위 체크)         │
│                                         │
│   → 다중 태깅 가능 (예: 설명+질문)     │
│   → 신뢰도 점수 산출                    │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│   Phase 3: 인지/상호작용 수준 분류      │
│                                         │
│   인지 수준 (Bloom's Taxonomy):         │
│   - Level 1: 기억/이해 (체크 3개)      │
│   - Level 2: 적용/분석 (체크 3개)      │
│   - Level 3: 평가/창조 (체크 3개)      │
│                                         │
│   상호작용 패턴 (IRF 분석):             │
│   - 교사 주도형 (체크 3개)              │
│   - 단순 응답형 (체크 2개)              │
│   - 확장 대화형 (체크 3개)              │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│   Phase 4: 매트릭스 생성                │
│                                         │
│   3차원 데이터 큐브 구축:               │
│   - X축: 시간 (도입/전개/정리)         │
│   - Y축: 맥락 (5가지 교수 기능)        │
│   - Z축: 수준 (3단계 인지 수준)        │
│                                         │
│   → 각 셀에 발화 빈도 기록              │
│   → 15×5 = 75개 셀 데이터               │
└─────────────────────────────────────────┘
              ↓
        Matrix Output
```

**데이터 구조 예시**
```json
{
  "matrix": {
    "introduction": {
      "explain": {"L1": 5, "L2": 2, "L3": 0},
      "question": {"L1": 3, "L2": 1, "L3": 0},
      "feedback": {"L1": 0, "L2": 0, "L3": 0},
      "facilitate": {"L1": 1, "L2": 0, "L3": 0},
      "manage": {"L1": 2, "L2": 0, "L3": 0}
    },
    "development": { ... },
    "closing": { ... }
  }
}
```

**일관성 보장 메커니즘**
1. 모든 판단은 이진 체크리스트 (temperature=0)
2. 각 체크 항목당 3회 실행 → 다수결
3. 애매한 경우 "중간값" 없이 강제 선택
4. 검증 규칙으로 비정상 패턴 감지

---

### Module 3: 평가 및 코칭

```
입력: 3D 매트릭스 + 발화 원문
출력: 정량 지표 + 코칭 피드백

┌─────────────────────────────────────────────┐
│   Step 1: 정량 지표 산출 (규칙 엔진)        │
│                                             │
│   완전히 결정론적 계산:                     │
│   - 시간 배분 지표 (비율 계산)              │
│   - 맥락 전환 지표 (Shannon Entropy)        │
│   - 인지 복잡도 지표 (가중 평균)            │
│   - 상호작용 패턴 지표 (빈도/비율)          │
│   - 복합 패턴 지표 (조합 패턴 매칭)         │
│                                             │
│   → 15개 핵심 지표 생성                     │
│   → 각 지표는 0-100 척도로 정규화           │
└─────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────┐
│   Step 2: 패턴 매칭 분석                    │
│                                             │
│   미리 정의된 이상적 패턴과 비교:           │
│   - 패턴 A: 탐구 중심 수업                  │
│   - 패턴 B: 개념 이해 수업                  │
│   - 패턴 C: 토론 중심 수업                  │
│   - 패턴 D: 기능 훈련 수업                  │
│                                             │
│   → 코사인 유사도 계산                      │
│   → 가장 유사한 패턴 식별                   │
└─────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────┐
│   Step 3: 강점/개선점 자동 식별             │
│                                             │
│   규칙 기반 판단:                           │
│   IF 지표 > 상위 20% → 강점                │
│   IF 지표 < 하위 20% → 개선점              │
│                                             │
│   발화 예시 자동 추출:                      │
│   - 강점에 해당하는 실제 발화 찾기          │
│   - 개선점에 해당하는 실제 발화 찾기        │
└─────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────┐
│   Step 4: AI 코칭 생성 (Claude API)         │
│                                             │
│   입력: 정량 지표 + 발화 예시               │
│   프롬프트 구조:                            │
│   1. 시스템 프롬프트 (코치 역할)            │
│   2. 평가 루브릭 (일관성 보장)              │
│   3. 정량 데이터 (객관적 근거)              │
│   4. 템플릿 구조 (출력 형식 강제)           │
│                                             │
│   출력:                                     │
│   - 강점 3가지 (각 100자 이내)              │
│   - 개선점 3가지 (각 100자 이내)            │
│   - 구체적 실천 방안 (각 150자 이내)        │
└─────────────────────────────────────────────┘
              ↓
        Evaluation Output
```

**일관성 보장 전략**

1. **AI는 "평가하지 않음"**
   - AI는 숫자 데이터를 받아 코칭 문구만 생성
   - 실제 평가는 규칙 엔진이 담당

2. **템플릿 기반 생성**
   ```
   IF 고차원_질문_비율 > 70%:
       템플릿 = "학생 사고를 확장하는 질문이 {비율}%로..."
   ELSE IF 고차원_질문_비율 > 50%:
       템플릿 = "의미 있는 질문이 {비율}%를 차지하나..."
   ```

3. **JSON Schema 강제**
   - 출력 구조를 JSON으로 엄격히 정의
   - 스키마 검증 실패 시 재생성

---

### Module 4: 리포트 생성

```
입력: 분석 결과 전체 (JSON)
출력: PDF 리포트 + 웹 대시보드

┌─────────────────────────────────────────┐
│   Component 1: 통계 차트 생성           │
│                                         │
│   - 레이더 차트 (15개 지표)            │
│   - 시간 배분 파이 차트                 │
│   - 맥락 분포 바 차트                   │
│   - 수준별 히트맵                       │
│   - 시계열 변화 그래프 (이전 수업 비교) │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│   Component 2: 인바디형 진단표          │
│                                         │
│   각 지표를 시각화:                     │
│   ████████░░ 80/100 (상위 15%)         │
│   ████░░░░░░ 40/100 (하위 30%)         │
│                                         │
│   색상 코딩:                            │
│   - 녹색: 상위 20% (강점)              │
│   - 노란색: 중간 60%                    │
│   - 빨간색: 하위 20% (개선 필요)        │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│   Component 3: 코칭 섹션                │
│                                         │
│   1. 종합 소견 (200자)                  │
│   2. 주요 강점 3가지 (발화 예시 포함)   │
│   3. 개선 영역 3가지 (발화 예시 포함)   │
│   4. 다음 수업 목표 (SMART 형식)        │
│   5. 참고 자료 링크                     │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│   Component 4: 상세 데이터 테이블       │
│                                         │
│   - 전체 발화 목록 (시간순)             │
│   - 단계/맥락/수준 태그                 │
│   - 발화별 체크리스트 결과              │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│   Output Generation                     │
│                                         │
│   - PDF 리포트 (인쇄용)                 │
│   - HTML 대시보드 (웹 뷰)               │
│   - CSV 데이터 (연구용)                 │
│   - JSON 원본 (재분석용)                │
└─────────────────────────────────────────┘
```

**리포트 구성**

1. **표지**: 교사명, 수업 정보, 분석 일시
2. **종합 진단**: 레이더 차트 + 전체 점수
3. **영역별 분석**: 15개 지표 상세
4. **시간별 분석**: 도입/전개/정리 비교
5. **코칭 섹션**: AI 생성 피드백
6. **비교 분석**: 이전 수업 대비 변화
7. **부록**: 전체 발화 목록

---

## 데이터 흐름 상세

### 입력 데이터
```json
{
  "video_file": "lesson_20251108.mp4",
  "metadata": {
    "teacher_name": "김지훈",
    "grade": "고등학교 2학년",
    "subject": "국어",
    "topic": "문학의 갈래",
    "date": "2025-11-08",
    "duration": 2700
  }
}
```

### 중간 데이터 (Module 1 출력)
```json
{
  "teacher_utterances": [
    {
      "id": 1,
      "start": 0.5,
      "end": 3.2,
      "text": "안녕하세요 여러분.",
      "confidence": 0.95
    },
    ...
  ],
  "quality_metrics": {
    "teacher_ratio": 0.76,
    "avg_confidence": 0.91
  }
}
```

### 중간 데이터 (Module 2 출력)
```json
{
  "utterances_analyzed": [
    {
      "id": 1,
      "text": "안녕하세요 여러분.",
      "stage": "introduction",
      "context": ["manage"],
      "cognitive_level": 1,
      "interaction_type": "teacher_led"
    },
    ...
  ],
  "matrix_3d": { ... }
}
```

### 최종 출력 (Module 3 출력)
```json
{
  "quantitative_metrics": {
    "time_distribution": {...},
    "context_entropy": 2.3,
    "cognitive_complexity": 65,
    ...
  },
  "pattern_match": {
    "best_match": "inquiry_based",
    "similarity": 0.82
  },
  "coaching": {
    "strengths": [...],
    "improvements": [...],
    "next_steps": [...]
  }
}
```

---

## 확장성 고려사항

### 수평 확장
- 영상 처리: 작업 큐 시스템 (Celery + Redis)
- 다중 사용자: 로드 밸런싱 (Nginx)
- 데이터베이스: 읽기 복제본 구성

### 수직 확장
- GPU 서버: Whisper 가속
- 메모리: 대용량 영상 처리 (2GB+ 영상)
- 스토리지: 영상 파일 아카이빙

### 성능 최적화
- 영상 전처리 캐싱
- 분석 결과 캐싱 (동일 영상 재분석)
- 배치 처리 (다수 영상 동시 처리)

---

## 보안 및 프라이버시

### 데이터 보호
- 영상 파일 암호화 저장
- 개인정보 비식별화 옵션
- 분석 완료 후 영상 자동 삭제 옵션

### 접근 제어
- 사용자 인증 (JWT)
- 교사별 데이터 격리
- 관리자 권한 분리

### 규정 준수
- 개인정보보호법 준수
- 교육 데이터 윤리 가이드라인
- 연구 윤리 IRB 승인

---

## 모니터링 및 로깅

### 시스템 모니터링
- 처리 시간 추적
- 오류율 모니터링
- 리소스 사용률 (CPU/GPU/메모리)

### 품질 모니터링
- 전사 정확도 샘플링
- 화자 분리 신뢰도 추적
- 사용자 피드백 수집

### 로깅 전략
- 구조화된 로그 (JSON)
- 단계별 처리 로그
- 오류 스택 트레이스
