#!/usr/bin/env python3
"""
Test the clean UI with proper API routing (no exposed ports)
"""

from playwright.sync_api import sync_playwright
import time

def test_clean_ui():
    print("üß™ Testing clean UI with proper API routing")
    print("=" * 55)
    
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=False)
        page = browser.new_page()
        
        # Monitor network requests
        def log_request(request):
            print(f"üì§ Request: {request.method} {request.url}")
        
        def log_response(response):
            print(f"üì• Response: {response.status} {response.url}")
            
        page.on("request", log_request)
        page.on("response", log_response)
        page.on("console", lambda msg: print(f"Console: {msg.text}"))
        
        try:
            print("üåê Loading AIBOA...")
            page.goto("http://3.38.107.23:3000")
            page.wait_for_selector("h1")
            print("‚úÖ Page loaded")
            
            # Test tab switching
            print("\nüìä Testing tab switching...")
            page.click("text=üìä Î∂ÑÏÑù")
            time.sleep(1)
            
            # Check if analysis tab is visible
            analysis_tab = page.query_selector("#analysis-tab")
            is_hidden = "hidden" in (analysis_tab.get_attribute("class") or "")
            print(f"üìã Analysis tab hidden: {is_hidden}")
            
            if not is_hidden:
                print("‚úÖ Tab switching works!")
                
                # Test analysis
                print("\nüß™ Testing analysis...")
                page.fill("#analysis-text", "ÏÑ†ÏÉùÎãòÏù¥ ÌïôÏÉùÎì§ÏóêÍ≤å ÏàòÌïô Î¨∏Ï†úÎ•º ÏÑ§Î™ÖÌñàÏäµÎãàÎã§. Í∑∏Î¶¨Í≥† Ïôú Í∑∏Î†áÍ≤å ÌíÄÏñ¥Ïïº ÌïòÎäîÏßÄ Ïù¥Ïú†Î•º Î¨ºÏñ¥Î≥¥ÏïòÏäµÎãàÎã§.")
                
                page.click("#analyze-btn")
                print("üöÄ Analysis started")
                
                # Wait for result
                for i in range(10):
                    time.sleep(1)
                    result_div = page.query_selector("#analysis-result")
                    if result_div:
                        content = result_div.text_content()
                        if content and "Ï†ÑÏ≤¥ Ï†êÏàò" in content:
                            print("üéâ SUCCESS: Detailed analysis result displayed!")
                            break
                        elif content and "Î∂ÑÏÑù" in content and len(content) > 50:
                            print("‚úÖ SUCCESS: Analysis completed!")
                            break
                    print(f"‚è≥ Waiting... ({i+1}/10)")
                
                # Final result check
                final_result = page.text_content("#analysis-result") or ""
                print(f"üìä Final result: {final_result[:100]}...")
                
                # Take screenshot
                page.screenshot(path="clean_ui_test.png")
                print("üì∏ Screenshot saved")
                
                return len(final_result) > 20
            else:
                print("‚ùå Tab switching failed")
                return False
                
        except Exception as e:
            print(f"‚ùå Error: {e}")
            return False
            
        finally:
            time.sleep(3)
            browser.close()

if __name__ == "__main__":
    success = test_clean_ui()
    print(f"\nüèÅ Clean UI Test: {'SUCCESS' if success else 'FAILED'}")