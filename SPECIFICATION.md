# 기능 명세서 (Functional Specification)

## 1. 핵심 기능 정의

### 1.1 교사 발화 분리 및 전사

#### 기능 설명
수업 영상에서 교사의 음성만 자동으로 추출하고 텍스트로 변환

#### 입력
- 영상 파일 (mp4, avi, mov, webm)
- 최대 파일 크기: 5GB
- 최소 영상 길이: 10분
- 최대 영상 길이: 120분

#### 출력
```json
{
  "teacher_utterances": [
    {
      "id": number,
      "start": float,  // 초 단위
      "end": float,
      "duration": float,
      "text": string,
      "word_count": number,
      "confidence": float  // 0-1
    }
  ],
  "metadata": {
    "total_duration": float,
    "teacher_speaking_time": float,
    "teacher_ratio": float,  // 0-1
    "avg_confidence": float
  }
}
```

#### 성능 요구사항
| 지표 | 목표 |
|------|------|
| 전사 정확도 | 95% 이상 |
| 화자 분리 정확도 (DER) | 5% 이하 |
| 처리 속도 | 실시간의 0.3-0.5배 (45분→15-20분) |
| 교사 발화 식별 정확도 | 95% 이상 |

#### 품질 검증 규칙
- ✅ 교사 발화 비율이 60-90% 범위인가?
- ✅ 평균 신뢰도가 0.8 이상인가?
- ✅ 연속 3개 이상 학생 발화가 없는가?
- ✅ 전체 발화 수가 50개 이상인가?

---

### 1.2 3차원 매트릭스 분석

#### 기능 설명
교사 발화를 시간(수업단계) × 맥락(교수기능) × 수준(인지/상호작용) 3차원으로 분석

#### 입력
Module 1의 출력 (교사 발화 타임라인)

#### 처리 과정

**Step 1: 수업 단계 분류**

각 발화를 도입/전개/정리 중 하나로 분류

체크리스트:
```yaml
introduction_signals:
  - 학습목표_언급: bool
  - 시작표현_사용: bool  # "오늘은", "이번 시간"
  - 동기유발_질문: bool
  - 전시학습_상기: bool
  - 수업계획_안내: bool

development_signals:
  - 새로운_내용_설명: bool
  - 학생활동_지시: bool
  - 심화질문_사용: bool
  - 전환표현_사용: bool  # "그렇다면", "이제"
  - 예시자료_제시: bool

closing_signals:
  - 정리표현_사용: bool  # "정리하면", "요약하면"
  - 핵심개념_재확인: bool
  - 다음차시_예고: bool
  - 과제_안내: bool
  - 회고표현_사용: bool  # "오늘 배운 것"
```

판정 로직:
```
IF introduction_signals_count >= 2 AND time < 전체시간*0.3:
    stage = "introduction"
ELSE IF closing_signals_count >= 2 AND time > 전체시간*0.7:
    stage = "closing"
ELSE:
    stage = "development"
```

**Step 2: 교수학적 맥락 태깅**

각 발화를 5가지 교수 기능으로 분류 (다중 태그 가능)

```yaml
A_explain:  # 설명형
  - 개념_정의: bool
  - 예시_제시: bool
  - 절차_설명: bool
  - 인과_설명: bool

B_question:  # 질문형
  - 사실확인_질문: bool  # What
  - 이유탐구_질문: bool  # Why
  - 방법_질문: bool      # How
  - 적용전이_질문: bool
  - 평가판단_질문: bool

C_feedback:  # 피드백형
  - 단순긍정부정: bool
  - 구체적_근거: bool
  - 사고확장: bool
  - 오개념_다루기: bool

D_facilitate:  # 촉진형
  - 대기시간_제공: bool  # 3초 이상 침묵
  - 힌트_제공: bool
  - 격려표현: bool
  - 재진술: bool

E_manage:  # 관리형
  - 행동지시: bool
  - 주의환기: bool
  - 시간관리: bool
```

**Step 3: 인지/상호작용 수준 분류**

인지 수준 (Bloom's Taxonomy):
```yaml
level_1_remember_understand:
  - 단순사실_확인: bool
  - 정의개념_반복: bool
  - 교과서_내용_그대로: bool

level_2_apply_analyze:
  - 새로운_상황_적용: bool
  - 비교대조: bool
  - 원인분석: bool

level_3_evaluate_create:
  - 판단평가_요구: bool
  - 새로운_해석: bool
  - 문제해결_창의성: bool
```

상호작용 패턴:
```yaml
teacher_led:
  - 교사발화_연속: bool
  - 즉시_다음_발화: bool
  - 강의식_진행: bool

simple_IRF:
  - IRF_패턴: bool  # Initiation-Response-Feedback
  - 단답형_응답: bool

extended_dialogue:
  - 후속질문_존재: bool
  - 학생간_상호작용: bool
  - 사고_재탐색: bool
```

#### 출력

3차원 매트릭스 (15×5 = 75개 셀):
```json
{
  "matrix": {
    "introduction": {
      "explain":     {"L1": 5, "L2": 2, "L3": 0},
      "question":    {"L1": 3, "L2": 1, "L3": 0},
      "feedback":    {"L1": 0, "L2": 0, "L3": 0},
      "facilitate":  {"L1": 1, "L2": 0, "L3": 0},
      "manage":      {"L1": 2, "L2": 0, "L3": 0}
    },
    "development": {
      "explain":     {"L1": 15, "L2": 10, "L3": 3},
      "question":    {"L1": 8, "L2": 12, "L3": 5},
      "feedback":    {"L1": 5, "L2": 8, "L3": 2},
      "facilitate":  {"L1": 2, "L2": 3, "L3": 1},
      "manage":      {"L1": 3, "L2": 0, "L3": 0}
    },
    "closing": {
      "explain":     {"L1": 4, "L2": 2, "L3": 0},
      "question":    {"L1": 2, "L2": 3, "L3": 1},
      "feedback":    {"L1": 1, "L2": 1, "L3": 0},
      "facilitate":  {"L1": 0, "L2": 0, "L3": 0},
      "manage":      {"L1": 1, "L2": 0, "L3": 0}
    }
  },
  "utterances_with_tags": [
    {
      "id": 1,
      "text": "안녕하세요 여러분.",
      "stage": "introduction",
      "contexts": ["manage"],
      "cognitive_level": 1,
      "interaction": "teacher_led"
    },
    ...
  ]
}
```

#### 성능 요구사항
| 작업 | 목표 처리 시간 |
|------|---------------|
| 단계 분류 (100개 발화) | 30초 이내 |
| 맥락 태깅 (100개 발화) | 60초 이내 |
| 수준 분류 (100개 발화) | 45초 이내 |
| 전체 분석 | 2분 이내 |

#### 일관성 보장 메커니즘
1. **다수결 투표**: 각 체크 항목을 3회 실행 → 2/3 이상 일치 시 채택
2. **신뢰도 점수**: 각 태그에 신뢰도 부여 (0-1)
3. **검증 규칙**: 비정상 패턴 자동 감지
   - 전개 단계가 전체의 50% 미만이면 경고
   - 모든 발화가 L1이면 경고
   - 관리형이 30% 초과면 경고

---

### 1.3 정량적 평가 및 지표 산출

#### 기능 설명
3차원 매트릭스를 기반으로 15개 핵심 지표를 계산 (완전 결정론적)

#### 입력
Module 2의 출력 (3D 매트릭스)

#### 출력 지표

**카테고리 1: 시간 배분 지표**

| 지표명 | 계산식 | 범위 | 해석 |
|--------|--------|------|------|
| 도입_시간_비율 | 도입발화시간 / 전체시간 | 0-1 | 적정: 0.1-0.2 |
| 전개_시간_비율 | 전개발화시간 / 전체시간 | 0-1 | 적정: 0.6-0.8 |
| 정리_시간_비율 | 정리발화시간 / 전체시간 | 0-1 | 적정: 0.1-0.2 |
| 발화_밀도 | 발화수 / 시간(분) | 개/분 | 적정: 2-4 |

**카테고리 2: 맥락 분포 지표**

| 지표명 | 계산식 | 범위 |
|--------|--------|------|
| 질문_비율 | 질문형발화 / 전체발화 | 0-1 |
| 설명_비율 | 설명형발화 / 전체발화 | 0-1 |
| 피드백_비율 | 피드백형발화 / 전체발화 | 0-1 |
| 맥락_다양성 | Shannon Entropy | 0-2.32 |

Shannon Entropy 계산:
```
H = -Σ(pi * log2(pi))
여기서 pi = 각 맥락 타입의 비율
```

**카테고리 3: 인지적 복잡도 지표**

| 지표명 | 계산식 | 범위 |
|--------|--------|------|
| 평균_인지_수준 | (L1×1 + L2×2 + L3×3) / 전체 | 1-3 |
| 고차원_사고_비율 | (L2+L3) / 전체 | 0-1 |
| 인지_상승_패턴 | 도입→전개→정리 수준 변화 | - |

**카테고리 4: 상호작용 지표**

| 지표명 | 계산식 | 범위 |
|--------|--------|------|
| 확장대화_비율 | 확장대화형 / 전체상호작용 | 0-1 |
| 평균_대기시간 | 촉진형_대기 / 촉진형_총횟수 | 초 |
| IRF_패턴_비율 | 단순IRF / 전체상호작용 | 0-1 |

**카테고리 5: 복합 패턴 지표**

| 지표명 | 설명 | 계산 |
|--------|------|------|
| 전개_질문_심화도 | 전개 단계의 고차원 질문 비율 | (전개 L2+L3 질문) / (전개 전체 질문) |
| 피드백_구체성 | 구체적 피드백 비율 | (구체적근거 피드백) / (전체 피드백) |
| 패턴_일치도 | 이상적 패턴과 유사도 | 코사인 유사도 (0-1) |

#### 정규화 및 점수화

모든 지표를 0-100 척도로 변환:
```python
def normalize_score(value, min_val, max_val, optimal_range):
    """
    optimal_range: (lower, upper) 
    예: 질문_비율의 optimal_range = (0.3, 0.5)
    """
    if optimal_range[0] <= value <= optimal_range[1]:
        # 최적 범위 내: 80-100점
        return 80 + 20 * ((value - optimal_range[0]) / 
                          (optimal_range[1] - optimal_range[0]))
    elif value < optimal_range[0]:
        # 최적 범위 미만: 0-80점
        return 80 * (value / optimal_range[0])
    else:
        # 최적 범위 초과: 80-0점 (과다)
        excess = (value - optimal_range[1]) / (max_val - optimal_range[1])
        return 80 * (1 - excess)
```

#### 성능 요구사항
- 모든 지표 계산: 1초 이내
- 재현성: 동일 입력 → 100% 동일 출력

---

### 1.4 AI 코칭 피드백 생성

#### 기능 설명
정량 지표를 바탕으로 교사에게 구체적이고 실행 가능한 코칭 제공

#### 입력
```json
{
  "quantitative_metrics": { ... },  // 15개 지표
  "utterances": [ ... ],             // 발화 원문
  "pattern_match": { ... }           // 패턴 매칭 결과
}
```

#### AI 프롬프트 구조

```
[시스템 프롬프트]
당신은 20년 경력의 수업 컨설턴트입니다.
주어진 정량 데이터를 바탕으로 교사에게 건설적 코칭을 제공합니다.

[평가 루브릭]
- 강점: 상위 20% 지표
- 개선점: 하위 20% 지표
- 각 항목당 100자 이내로 작성
- 실제 발화 예시를 반드시 포함

[입력 데이터]
{정량 지표 JSON}

[출력 템플릿]
{
  "overall_assessment": "200자 이내 종합 평가",
  "strengths": [
    {
      "area": "영역명",
      "score": 85,
      "description": "100자 설명",
      "example": "실제 발화 예시"
    }
  ],
  "improvements": [
    {
      "area": "영역명",
      "score": 35,
      "description": "100자 설명",
      "example": "실제 발화 예시",
      "suggestion": "150자 구체적 개선 방안"
    }
  ],
  "next_steps": [
    "다음 수업 목표 1",
    "다음 수업 목표 2",
    "다음 수업 목표 3"
  ]
}
```

#### 일관성 보장 전략

1. **조건부 템플릿 사용**
```python
templates = {
    "high_question_ratio": {
        "condition": lambda m: m['질문_비율'] > 0.4,
        "template": "학생 참여를 유도하는 질문이 {질문_비율:.0%}로 우수합니다..."
    },
    "low_question_ratio": {
        "condition": lambda m: m['질문_비율'] < 0.2,
        "template": "질문이 {질문_비율:.0%}로 부족합니다. 학생 사고를 촉진하는..."
    }
}
```

2. **JSON Schema 검증**
```json
{
  "type": "object",
  "required": ["overall_assessment", "strengths", "improvements", "next_steps"],
  "properties": {
    "overall_assessment": {
      "type": "string",
      "maxLength": 200
    },
    "strengths": {
      "type": "array",
      "minItems": 3,
      "maxItems": 3
    },
    ...
  }
}
```

3. **재시도 로직**
```python
max_retries = 3
for attempt in range(max_retries):
    response = call_claude_api(prompt)
    if validate_schema(response):
        break
    else:
        prompt += f"\n\n이전 출력이 스키마를 위반했습니다: {validation_error}"
```

#### 출력 예시

```json
{
  "overall_assessment": "학생 참여를 유도하는 질문이 풍부하나, 전개 단계에서 심화된 사고를 이끄는 후속 질문이 부족합니다. 피드백이 구체적이라는 점은 긍정적입니다.",
  
  "strengths": [
    {
      "area": "질문 빈도",
      "score": 85,
      "description": "전체 발화 중 40%가 질문으로, 학생 참여를 적극적으로 유도하고 있습니다.",
      "example": "[12:34] 이 작품에서 인물의 갈등이 어떻게 드러나나요?"
    },
    {
      "area": "피드백 구체성",
      "score": 78,
      "description": "학생 답변에 대해 근거를 들어 피드백하는 비율이 높습니다.",
      "example": "[15:20] 민지가 말한 '고독'이라는 표현이 좋네요. 시어에서 그 느낌을 잘 찾았어요."
    },
    {
      "area": "시간 배분",
      "score": 82,
      "description": "도입-전개-정리의 시간 배분이 이상적입니다 (15%-70%-15%).",
      "example": "도입 7분, 전개 32분, 정리 6분으로 균형적입니다."
    }
  ],
  
  "improvements": [
    {
      "area": "사고 심화 질문",
      "score": 42,
      "description": "고차원적 사고를 요구하는 질문이 전체의 15%에 불과합니다.",
      "example": "[18:45] 주인공의 행동이 맞나요? (단순 판단 질문)",
      "suggestion": "'왜 그런 선택을 했을까?', '다르게 행동했다면?'처럼 사고를 확장하는 후속 질문을 3초 대기 후 추가해보세요."
    },
    {
      "area": "학생 대기 시간",
      "score": 38,
      "description": "질문 후 평균 1.2초만 기다리고 다음 발화로 넘어갑니다.",
      "example": "[22:10] 이 시의 주제가 뭘까요? [1초 후] 사랑이죠? 맞아요.",
      "suggestion": "질문 후 최소 3-5초 기다려주세요. 학생들이 생각할 시간을 주면 더 깊은 답변이 나옵니다."
    },
    {
      "area": "학생 간 상호작용",
      "score": 25,
      "description": "학생-학생 대화를 촉진하는 발화가 거의 없습니다 (2%).",
      "example": "(해당 발화 없음)",
      "suggestion": "'다른 친구들은 어떻게 생각해?', '서로 의견을 나눠볼까?' 등으로 또래 학습을 유도해보세요."
    }
  ],
  
  "next_steps": [
    "다음 수업: 질문 후 3초 이상 대기하기 (타이머 활용)",
    "한 수업에 '왜?', '어떻게?' 질문을 최소 5회 이상 사용하기",
    "소그룹 토론 시간 5분 배정하여 학생 간 상호작용 기회 제공"
  ]
}
```

---

### 1.5 진단 리포트 생성

#### 기능 설명
분석 결과를 인바디 검사지처럼 시각화하여 PDF 및 웹으로 제공

#### 리포트 구성

**페이지 1: 표지**
- 교사명, 학교, 수업 정보
- 분석 일시
- 리포트 ID (추적용)

**페이지 2: 종합 진단**
- 레이더 차트 (15개 지표)
- 종합 점수 (0-100)
- 패턴 유형 (예: 탐구 중심형 82% 유사)

**페이지 3-4: 영역별 상세**
15개 지표 각각에 대해:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[지표명] 질문의 양과 질

점수: ████████░░ 78/100 (상위 25%)

측정값: 질문 비율 38%, 고차원 질문 15%

해석: 학생 참여를 유도하는 질문이 충분하나,
      고차원적 사고를 요구하는 질문 비중이 낮음

강점: 질문 빈도는 우수
개선: 'Why', 'How' 질문 늘리기

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**페이지 5: 시간별 분석**
- 도입/전개/정리 시간 배분 파이 차트
- 단계별 맥락 분포 누적 바 차트
- 시간 흐름에 따른 인지 수준 변화 그래프

**페이지 6-7: AI 코칭**
- 종합 소견
- 주요 강점 3가지 (발화 예시 포함)
- 개선 영역 3가지 (구체적 방안 포함)
- 다음 수업 목표

**페이지 8: 비교 분석 (선택)**
- 이전 수업과 비교 (있는 경우)
- 지표별 변화 추이
- 성장 포인트

**페이지 9: 부록**
- 전체 발화 목록 (시간순)
- 단계/맥락/수준 태그
- 체크리스트 상세 결과

#### 차트 명세

**레이더 차트**
```python
metrics = [
    "질문빈도", "질문깊이", "피드백구체성", "대기시간",
    "학생참여", "인지수준", "시간배분", "맥락다양성",
    "설명명료성", "상호작용", "도입효과", "전개심화",
    "정리효과", "패턴일치도", "전체균형"
]
scores = [78, 42, 85, 38, 65, 55, 82, 70, 75, 45, 80, 60, 78, 82, 68]
```

**히트맵 (3D 매트릭스 시각화)**
```
        설명  질문  피드백  촉진  관리
도입L1  ████  ██    ░░    ░░    ███
도입L2  ██    ░░    ░░    ░░    ░░
도입L3  ░░    ░░    ░░    ░░    ░░
전개L1  █████ ████  ███   ░░    ░░
전개L2  ████  █████ ████  ██    ░░
전개L3  ░░    ███   ██    ░░    ░░
...
```

#### 출력 형식

1. **PDF (인쇄용)**
   - A4 세로
   - 300 DPI
   - 폰트: Noto Sans KR

2. **HTML (웹뷰)**
   - 반응형 디자인
   - 인터랙티브 차트 (Chart.js)
   - 발화 클릭 시 영상 해당 시점 이동 (옵션)

3. **CSV (연구용)**
   - 발화별 모든 태그 데이터
   - 지표 원본 값
   - 재분석 가능

4. **JSON (원본)**
   - 전체 분석 결과
   - 재처리 가능
   - API 연동용

---

## 2. 비기능 요구사항

### 2.1 성능
- 45분 영상 전체 처리: 20분 이내 (GPU 사용 시)
- 동시 처리: 최대 5개 영상
- 응답 시간: API 호출 시 3초 이내

### 2.2 확장성
- 사용자 수: 1,000명 이상 지원
- 영상 저장: 무제한 (클라우드 스토리지)
- 분석 이력: 교사당 최대 100개 수업

### 2.3 신뢰성
- 가동률: 99.5% 이상
- 데이터 손실: 0%
- 오류 복구: 자동 재시도

### 2.4 보안
- 데이터 암호화: AES-256
- 전송 암호화: TLS 1.3
- 개인정보: 비식별화 옵션

### 2.5 사용성
- 학습 시간: 10분 이내
- 업로드 진행률 표시
- 분석 상태 실시간 업데이트

---

## 3. 품질 보증

### 3.1 일관성 검증

**테스트 방법**
1. 동일 영상을 10회 재분석
2. 15개 지표의 표준편차 계산
3. 모든 지표의 표준편차 < 5% 확인

**합격 기준**
- 재현율: 95% 이상
- 주요 지표 일관성: 98% 이상

### 3.2 정확도 검증

**테스트 방법**
1. 전문가 3명이 수동 분석
2. 시스템 자동 분석 결과와 비교
3. Cohen's Kappa 계산

**합격 기준**
- 화자 분리: Kappa > 0.9
- 단계 분류: Kappa > 0.85
- 맥락 태깅: Kappa > 0.80
- 수준 분류: Kappa > 0.75

### 3.3 사용자 만족도

**평가 항목**
- 리포트 유용성: 4.0/5.0 이상
- 피드백 구체성: 4.0/5.0 이상
- 시스템 사용 용이성: 4.5/5.0 이상

---

## 4. 제약사항 및 전제조건

### 4.1 기술적 제약
- GPU 서버 필요 (CUDA 11.0+)
- 최소 RAM: 16GB
- 디스크 공간: 100GB+

### 4.2 사용 제약
- 한국어 수업만 지원
- 배경 소음 심한 영상은 정확도 저하
- 화자 수가 10명 이상이면 분리 어려움

### 4.3 법적 제약
- 영상 촬영 시 학생 동의 필요
- 개인정보보호법 준수
- 연구 목적 사용 시 IRB 승인

---

## 5. 향후 확장 계획

### Phase 2 (6개월 후)
- 영어 수업 지원
- 실시간 분석 (라이브 스트리밍)
- 모바일 앱

### Phase 3 (1년 후)
- 다중 카메라 지원
- 학생 발화 분석 추가
- 비언어적 요소 분석 (제스처, 표정)

### Phase 4 (2년 후)
- 학교/지역 벤치마킹
- AI 개인화 코칭 강화
- VR/AR 수업 시뮬레이션
