#!/usr/bin/env python3
"""
ÍµêÏú° Ïª®ÏÑ§ÌåÖÏö© Ï†ÑÎ¨∏ PDF Î≥¥Í≥†ÏÑú ÏÉùÏÑ±Í∏∞
- CBIL 7Îã®Í≥Ñ Î∂ÑÏÑù ÏãúÍ∞ÅÌôî
- ÍµêÏú° Ï†ÑÎ¨∏Í∞ÄÏö© Í∞úÏÑ† Í∂åÏû•ÏÇ¨Ìï≠
- A4 Ïù∏ÏáÑ ÌíàÏßà Ï†ÑÎ¨∏ ÎîîÏûêÏù∏
"""

import os
import io
import base64
from datetime import datetime
from typing import Dict, List, Any
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
from matplotlib import rcParams
import numpy as np
from jinja2 import Template
import weasyprint
from weasyprint import HTML, CSS
from weasyprint.text.fonts import FontConfiguration

class EducationReportGenerator:
    def __init__(self):
        self.setup_korean_fonts()
        self.setup_matplotlib()
        
        # CBIL 7Îã®Í≥Ñ Ï†ïÏùò
        self.cbil_levels = {
            1: {"name": "Îã®Ïàú ÌôïÏù∏", "color": "#E8F4FD", "description": "Í∏∞Î≥∏Ï†ÅÏù∏ ÏÇ¨Ïã§ ÌôïÏù∏"},
            2: {"name": "ÏÇ¨Ïã§ ÌöåÏÉÅ", "color": "#D1E7DD", "description": "ÌïôÏäµ ÎÇ¥Ïö© Í∏∞Ïñµ"},
            3: {"name": "Í∞úÎÖê ÏÑ§Î™Ö", "color": "#FFF3CD", "description": "Í∞úÎÖê Ïù¥Ìï¥ Î∞è ÏÑ§Î™Ö"},
            4: {"name": "Î∂ÑÏÑùÏ†Å ÏÇ¨Í≥†", "color": "#FFE69C", "description": "ÏöîÏÜå Î∂ÑÏÑù Î∞è Í¥ÄÍ≥Ñ ÌååÏïÖ"},
            5: {"name": "Ï¢ÖÌï©Ï†Å Ïù¥Ìï¥", "color": "#FFAB91", "description": "ÌÜµÌï©Ï†Å ÏÇ¨Í≥†"},
            6: {"name": "ÌèâÍ∞ÄÏ†Å ÌåêÎã®", "color": "#FFCDD2", "description": "ÎπÑÌåêÏ†Å ÌèâÍ∞Ä"},
            7: {"name": "Ï∞ΩÏùòÏ†Å Ï†ÅÏö©", "color": "#D1C4E9", "description": "Ï∞ΩÏùòÏ†Å Î¨∏Ï†ú Ìï¥Í≤∞"}
        }
    
    def setup_korean_fonts(self):
        """ÌïúÍ∏Ä Ìè∞Ìä∏ ÏÑ§Ï†ï"""
        try:
            # macOS/Windows Í≥µÌÜµ ÌïúÍ∏Ä Ìè∞Ìä∏ Ï∞æÍ∏∞
            available_fonts = fm.findSystemFonts()
            korean_fonts = [
                'AppleSDGothicNeo-Regular',
                'Malgun Gothic',
                'NanumGothic',
                'DejaVu Sans'
            ]
            
            self.korean_font = None
            for font_name in korean_fonts:
                try:
                    if any(font_name in path for path in available_fonts):
                        self.korean_font = font_name
                        break
                except:
                    continue
            
            if not self.korean_font:
                self.korean_font = 'DejaVu Sans'  # fallback
                
        except Exception as e:
            print(f"Ìè∞Ìä∏ ÏÑ§Ï†ï Ïã§Ìå®: {e}")
            self.korean_font = 'DejaVu Sans'
    
    def setup_matplotlib(self):
        """Matplotlib ÏÑ§Ï†ï"""
        rcParams['font.family'] = 'sans-serif'
        rcParams['font.sans-serif'] = [self.korean_font, 'DejaVu Sans']
        rcParams['axes.unicode_minus'] = False
        plt.style.use('seaborn-v0_8-whitegrid')
    
    def create_cbil_bar_chart(self, cbil_scores: Dict[str, float]) -> str:
        """CBIL 7Îã®Í≥Ñ ÎßâÎåÄ Í∑∏ÎûòÌîÑ ÏÉùÏÑ±"""
        fig, ax = plt.subplots(figsize=(10, 6))
        
        levels = list(range(1, 8))
        scores = [cbil_scores.get(str(level), 0.0) for level in levels]
        colors = [self.cbil_levels[level]["color"] for level in levels]
        level_names = [f"Level {level}\n{self.cbil_levels[level]['name']}" for level in levels]
        
        bars = ax.bar(level_names, scores, color=colors, edgecolor='#333333', linewidth=1)
        
        # Í∞í ÌëúÏãú
        for bar, score in zip(bars, scores):
            height = bar.get_height()
            ax.text(bar.get_x() + bar.get_width()/2., height + 0.01,
                   f'{score:.1%}', ha='center', va='bottom', fontweight='bold')
        
        ax.set_title('CBIL 7Îã®Í≥Ñ Î∂ÑÏÑù Í≤∞Í≥º', fontsize=16, fontweight='bold', pad=20)
        ax.set_ylabel('ÎπÑÏú® (%)', fontsize=12)
        ax.set_ylim(0, max(scores) * 1.2 if scores else 1)
        ax.grid(axis='y', alpha=0.3)
        
        plt.xticks(rotation=45, ha='right')
        plt.tight_layout()
        
        # Base64 Ïù∏ÏΩîÎî©
        buffer = io.BytesIO()
        plt.savefig(buffer, format='png', dpi=300, bbox_inches='tight')
        buffer.seek(0)
        image_base64 = base64.b64encode(buffer.getvalue()).decode()
        plt.close()
        
        return f"data:image/png;base64,{image_base64}"
    
    def create_cbil_pie_chart(self, cbil_scores: Dict[str, float]) -> str:
        """CBIL Î∂ÑÌè¨ ÌååÏù¥ Ï∞®Ìä∏ ÏÉùÏÑ±"""
        fig, ax = plt.subplots(figsize=(8, 8))
        
        # ÎÇÆÏùå/Ï§ëÍ∞Ñ/ÎÜíÏùå Í∑∏Î£πÌôî
        low_levels = sum(cbil_scores.get(str(i), 0.0) for i in range(1, 3))
        mid_levels = sum(cbil_scores.get(str(i), 0.0) for i in range(3, 5))
        high_levels = sum(cbil_scores.get(str(i), 0.0) for i in range(5, 8))
        
        sizes = [low_levels, mid_levels, high_levels]
        labels = ['ÎÇÆÏùÄ ÏàòÏ§Ä\n(Level 1-2)', 'Ï§ëÍ∞Ñ ÏàòÏ§Ä\n(Level 3-4)', 'ÎÜíÏùÄ ÏàòÏ§Ä\n(Level 5-7)']
        colors = ['#FFE0E0', '#FFF8DC', '#E8F5E8']
        
        # ÎπÑÏñ¥ÏûàÎäî Í∞í Ï†úÍ±∞
        filtered_data = [(size, label, color) for size, label, color in zip(sizes, labels, colors) if size > 0]
        if filtered_data:
            sizes, labels, colors = zip(*filtered_data)
        
        wedges, texts, autotexts = ax.pie(sizes, labels=labels, colors=colors, autopct='%1.1f%%',
                                         startangle=90, textprops={'fontsize': 11})
        
        ax.set_title('CBIL ÏàòÏ§ÄÎ≥Ñ Î∂ÑÌè¨', fontsize=16, fontweight='bold', pad=20)
        
        # Base64 Ïù∏ÏΩîÎî©
        buffer = io.BytesIO()
        plt.savefig(buffer, format='png', dpi=300, bbox_inches='tight')
        buffer.seek(0)
        image_base64 = base64.b64encode(buffer.getvalue()).decode()
        plt.close()
        
        return f"data:image/png;base64,{image_base64}"
    
    def generate_recommendations(self, cbil_scores: Dict[str, float], overall_score: float) -> List[str]:
        """ÍµêÏú° Í∞úÏÑ† Í∂åÏû•ÏÇ¨Ìï≠ ÏÉùÏÑ±"""
        recommendations = []
        
        # Ï†ÑÏ≤¥ Ï†êÏàò Í∏∞Î∞ò Í∂åÏû•ÏÇ¨Ìï≠
        if overall_score < 2.5:
            recommendations.append("üìà Í∏∞Ï¥à Îã®Í≥Ñ: ÌïôÏäµÏûêÏùò Í∏∞Î≥∏ Ïù¥Ìï¥ÎèÑÎ•º ÎÜíÏù¥Îäî ÌôúÎèôÏùÑ ÎäòÎ†§Ï£ºÏÑ∏Ïöî.")
        elif overall_score < 4.0:
            recommendations.append("üéØ Î∞úÏ†Ñ Îã®Í≥Ñ: Î∂ÑÏÑùÏ†Å ÏÇ¨Í≥†Î•º Ï¥âÏßÑÌïòÎäî ÏßàÎ¨∏ÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.")
        else:
            recommendations.append("‚≠ê Ïö∞Ïàò Îã®Í≥Ñ: Ï∞ΩÏùòÏ†Å Ï†ÅÏö© Í∏∞ÌöåÎ•º Îçî ÎßéÏù¥ Ï†úÍ≥µÌï¥Ï£ºÏÑ∏Ïöî.")
        
        # Í∞úÎ≥Ñ Î†àÎ≤® Î∂ÑÏÑù
        high_levels = [5, 6, 7]
        high_level_total = sum(cbil_scores.get(str(level), 0.0) for level in high_levels)
        
        if high_level_total < 0.2:
            recommendations.append("üß† Í≥†Ï∞®ÏõêÏ†Å ÏÇ¨Í≥†(Level 5-7)Î•º Ïú†ÎèÑÌïòÎäî ÏßàÎ¨∏ÏùÑ ÎäòÎ†§Ï£ºÏÑ∏Ïöî.")
        
        if cbil_scores.get('7', 0.0) < 0.1:
            recommendations.append("üí° Ï∞ΩÏùòÏ†Å Î¨∏Ï†ú Ìï¥Í≤∞ Í∏∞ÌöåÎ•º Ï†úÍ≥µÌïòÏó¨ Level 7 ÌôúÎèôÏùÑ Ï¶ùÏßÑÏãúÏºúÏ£ºÏÑ∏Ïöî.")
        
        if cbil_scores.get('1', 0.0) > 0.4:
            recommendations.append("‚öñÔ∏è Îã®Ïàú ÌôïÏù∏ ÏßàÎ¨∏(Level 1)ÏùÑ Ï§ÑÏù¥Í≥† Îçî ÎèÑÏ†ÑÏ†ÅÏù∏ ÏßàÎ¨∏ÏúºÎ°ú Î∞úÏ†ÑÏãúÏºúÏ£ºÏÑ∏Ïöî.")
        
        # Í∑†Ìòï Î∂ÑÏÑù
        max_level = max(cbil_scores.items(), key=lambda x: x[1]) if cbil_scores else ('1', 0)
        if float(max_level[1]) > 0.5:
            recommendations.append(f"üîÑ Level {max_level[0]}Ïóê ÏßëÏ§ëÎêòÏñ¥ ÏûàÏäµÎãàÎã§. Îã§ÏñëÌïú ÏÇ¨Í≥† ÏàòÏ§ÄÏùò Í∑†ÌòïÏùÑ ÎßûÏ∂∞Ï£ºÏÑ∏Ïöî.")
        
        return recommendations[:5]  # ÏµúÎåÄ 5Í∞ú Í∂åÏû•ÏÇ¨Ìï≠
    
    def create_html_template(self) -> str:
        """HTML ÌÖúÌîåÎ¶ø ÏÉùÏÑ±"""
        return """
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIBOA ÍµêÏú° Î∂ÑÏÑù Î≥¥Í≥†ÏÑú</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
            @top-center {
                content: "AIBOA ÍµêÏú° Î∂ÑÏÑù Î≥¥Í≥†ÏÑú";
                font-family: "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
                font-size: 10pt;
                color: #666;
            }
            @bottom-center {
                content: "Page " counter(page) " of " counter(pages);
                font-family: "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
                font-size: 10pt;
                color: #666;
            }
        }
        
        body {
            font-family: "Apple SD Gothic Neo", "Malgun Gothic", "NanumGothic", sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 0;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24pt;
            font-weight: bold;
        }
        
        .header .subtitle {
            font-size: 14pt;
            opacity: 0.9;
            margin-top: 0.5rem;
        }
        
        .metadata {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border-left: 4px solid #667eea;
        }
        
        .metadata table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .metadata td {
            padding: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .metadata td:first-child {
            font-weight: bold;
            width: 30%;
            color: #495057;
        }
        
        .section {
            margin-bottom: 2rem;
            page-break-inside: avoid;
        }
        
        .section h2 {
            color: #667eea;
            font-size: 18pt;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
        }
        
        .score-highlight {
            text-align: center;
            background: #e8f4fd;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 2px solid #667eea;
        }
        
        .score-highlight .score {
            font-size: 36pt;
            font-weight: bold;
            color: #667eea;
            margin: 0;
        }
        
        .score-highlight .description {
            font-size: 14pt;
            color: #495057;
            margin-top: 0.5rem;
        }
        
        .chart-container {
            text-align: center;
            margin: 2rem 0;
            page-break-inside: avoid;
        }
        
        .chart-container img {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            background: white;
        }
        
        .recommendations {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .recommendations h3 {
            color: #856404;
            margin-top: 0;
            font-size: 16pt;
        }
        
        .recommendations ul {
            margin: 0;
            padding-left: 1.5rem;
        }
        
        .recommendations li {
            margin-bottom: 0.8rem;
            line-height: 1.7;
        }
        
        .footer {
            margin-top: 3rem;
            text-align: center;
            font-size: 10pt;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
            padding-top: 1rem;
        }
        
        .level-detail {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .level-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }
        
        .level-card .level-number {
            font-size: 24pt;
            font-weight: bold;
            color: #667eea;
        }
        
        .level-card .level-name {
            font-size: 14pt;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        
        .level-card .level-score {
            font-size: 18pt;
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéì AIBOA ÍµêÏú° Î∂ÑÏÑù Î≥¥Í≥†ÏÑú</h1>
        <div class="subtitle">CBIL(Cognitive Burden of Instructional Language) 7Îã®Í≥Ñ Î∂ÑÏÑù</div>
    </div>
    
    <div class="metadata">
        <table>
            <tr>
                <td>Î∂ÑÏÑù ÏùºÏãú</td>
                <td>{{ analysis_date }}</td>
            </tr>
            <tr>
                <td>ÎπÑÎîîÏò§ Ï†úÎ™©</td>
                <td>{{ video_title }}</td>
            </tr>
            <tr>
                <td>Î∂ÑÏÑù Î¨∏Ïû• Ïàò</td>
                <td>{{ sentence_count }}Í∞ú</td>
            </tr>
            <tr>
                <td>Î∂ÑÏÑù Î∞©Î≤ï</td>
                <td>AI Í∏∞Î∞ò CBIL 7Îã®Í≥Ñ Î∂ÑÎ•ò</td>
            </tr>
        </table>
    </div>
    
    <div class="section">
        <h2>üìä Ï¢ÖÌï© Î∂ÑÏÑù Í≤∞Í≥º</h2>
        <div class="score-highlight">
            <div class="score">{{ overall_score }}/7.0</div>
            <div class="description">Ï†ÑÏ≤¥ CBIL ÌèâÍ∑† Ï†êÏàò</div>
        </div>
    </div>
    
    <div class="section">
        <h2>üìà CBIL 7Îã®Í≥Ñ ÏÉÅÏÑ∏ Î∂ÑÏÑù</h2>
        <div class="chart-container">
            <img src="{{ bar_chart }}" alt="CBIL 7Îã®Í≥Ñ ÎßâÎåÄ Í∑∏ÎûòÌîÑ">
        </div>
        
        <div class="level-detail">
            {% for level, data in level_details.items() %}
            <div class="level-card">
                <div class="level-number">{{ level }}</div>
                <div class="level-name">{{ data.name }}</div>
                <div class="level-score">{{ "%.1f"|format(data.score * 100) }}%</div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="section">
        <h2>ü•ß ÏàòÏ§ÄÎ≥Ñ Î∂ÑÌè¨</h2>
        <div class="chart-container">
            <img src="{{ pie_chart }}" alt="CBIL ÏàòÏ§ÄÎ≥Ñ Î∂ÑÌè¨ ÌååÏù¥ Ï∞®Ìä∏">
        </div>
    </div>
    
    <div class="section">
        <h2>üí° ÍµêÏú° Í∞úÏÑ† Í∂åÏû•ÏÇ¨Ìï≠</h2>
        <div class="recommendations">
            <h3>üéØ ÎßûÏ∂§Ìòï Í∞úÏÑ† Î∞©Ïïà</h3>
            <ul>
                {% for recommendation in recommendations %}
                <li>{{ recommendation }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    
    <div class="footer">
        <p>Î≥∏ Î≥¥Í≥†ÏÑúÎäî AIBOA ÏãúÏä§ÌÖúÏóê ÏùòÌï¥ ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§ | ÏÉùÏÑ± ÏãúÍ∞Ñ: {{ generation_time }}</p>
        <p>ÍµêÏú° Ïª®ÏÑ§ÌåÖ Î∞è Î¨∏Ïùò: aiboa@example.com</p>
    </div>
</body>
</html>
        """
    
    def generate_pdf_report(self, analysis_data: Dict[str, Any], video_title: str = "Î∂ÑÏÑù ÎπÑÎîîÏò§") -> bytes:
        """PDF Î≥¥Í≥†ÏÑú ÏÉùÏÑ±"""
        try:
            # Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
            cbil_scores = analysis_data.get('cbil_scores', {})
            overall_score = analysis_data.get('overall_score', 0.0)
            
            # Ï∞®Ìä∏ ÏÉùÏÑ±
            bar_chart = self.create_cbil_bar_chart(cbil_scores)
            pie_chart = self.create_cbil_pie_chart(cbil_scores)
            
            # Í∂åÏû•ÏÇ¨Ìï≠ ÏÉùÏÑ±
            recommendations = self.generate_recommendations(cbil_scores, overall_score)
            
            # Î†àÎ≤® ÏÉÅÏÑ∏ Ï†ïÎ≥¥
            level_details = {}
            for level in range(1, 8):
                level_str = str(level)
                score = cbil_scores.get(level_str, 0.0)
                level_details[level] = {
                    'name': self.cbil_levels[level]['name'],
                    'score': score,
                    'description': self.cbil_levels[level]['description']
                }
            
            # HTML ÌÖúÌîåÎ¶ø Î†åÎçîÎßÅ
            template = Template(self.create_html_template())
            html_content = template.render(
                analysis_date=datetime.now().strftime("%YÎÖÑ %mÏõî %dÏùº %H:%M"),
                video_title=video_title,
                sentence_count=len(analysis_data.get('sentences', [])),
                overall_score=f"{overall_score:.1f}",
                bar_chart=bar_chart,
                pie_chart=pie_chart,
                level_details=level_details,
                recommendations=recommendations,
                generation_time=datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            )
            
            # PDF ÏÉùÏÑ±
            font_config = FontConfiguration()
            html_doc = HTML(string=html_content)
            pdf_bytes = html_doc.write_pdf(font_config=font_config)
            
            return pdf_bytes
            
        except Exception as e:
            print(f"PDF ÏÉùÏÑ± Ïã§Ìå®: {e}")
            raise
    
    def save_pdf_report(self, analysis_data: Dict[str, Any], output_path: str, video_title: str = "Î∂ÑÏÑù ÎπÑÎîîÏò§"):
        """PDF Î≥¥Í≥†ÏÑú ÌååÏùºÎ°ú Ï†ÄÏû•"""
        pdf_bytes = self.generate_pdf_report(analysis_data, video_title)
        
        with open(output_path, 'wb') as f:
            f.write(pdf_bytes)
        
        return output_path

# ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞Î°ú ÏÉòÌîå PDF ÏÉùÏÑ±
def test_pdf_generation():
    generator = EducationReportGenerator()
    
    # ÏÉòÌîå CBIL Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞
    sample_data = {
        'cbil_scores': {
            '1': 0.15,
            '2': 0.25, 
            '3': 0.30,
            '4': 0.20,
            '5': 0.08,
            '6': 0.02,
            '7': 0.00
        },
        'overall_score': 2.87,
        'sentences': ['Î¨∏Ïû•1', 'Î¨∏Ïû•2', 'Î¨∏Ïû•3'] * 10
    }
    
    pdf_path = "/tmp/aiboa_sample_report.pdf"
    generator.save_pdf_report(sample_data, pdf_path, "ÏÉòÌîå ÍµêÏú° ÏòÅÏÉÅ Î∂ÑÏÑù")
    print(f"‚úÖ ÏÉòÌîå PDF ÏÉùÏÑ± ÏôÑÎ£å: {pdf_path}")
    return pdf_path

if __name__ == "__main__":
    test_pdf_generation()