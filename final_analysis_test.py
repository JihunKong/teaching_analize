#!/usr/bin/env python3
"""
Final comprehensive analysis test with result area debugging
"""

from playwright.sync_api import sync_playwright
import time

def final_test():
    print("üéØ Final comprehensive analysis test")
    print("=" * 50)
    
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=False)
        page = browser.new_page()
        
        page.on("console", lambda msg: print(f"[{msg.type}] {msg.text}"))
        
        try:
            page.goto("http://3.38.107.23:3000")
            page.wait_for_selector("h1")
            print("‚úÖ Page loaded")
            
            # Force tab switching
            page.evaluate("""
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                document.getElementById('analysis-tab').classList.remove('hidden');
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('[onclick*="analysis"]').classList.add('active');
            """)
            time.sleep(1)
            
            # Fill text
            page.fill("#analysis-text", "ÏÑ†ÏÉùÎãòÏù¥ ÌïôÏÉùÎì§ÏóêÍ≤å ÏàòÌïô Î¨∏Ï†úÎ•º ÌíÄÏñ¥Î≥¥ÎùºÍ≥† ÌñàÏäµÎãàÎã§. Í∑∏ Îã§ÏùåÏóê Ïôú Í∑∏Î†áÍ≤å ÌíÄÏóàÎäîÏßÄ ÏÑ§Î™ÖÌï¥Îã¨ÎùºÍ≥† ÌñàÏñ¥Ïöî.")
            print("‚úçÔ∏è Text entered")
            
            # Ensure result div is visible before clicking
            page.evaluate("""
                const resultDiv = document.getElementById('analysis-result');
                if (resultDiv) {
                    resultDiv.classList.remove('hidden');
                    resultDiv.style.display = 'block';
                    console.log('Result div made visible');
                }
            """)
            
            # Click analyze
            page.click("#analyze-btn")
            print("üöÄ Analysis button clicked")
            
            # Wait and check result periodically
            for i in range(10):
                time.sleep(2)
                
                result_content = page.evaluate("""
                    const resultDiv = document.getElementById('analysis-result');
                    return resultDiv ? resultDiv.textContent : 'No result div';
                """)
                
                print(f"‚è≥ Check {i+1}: {result_content[:100]}...")
                
                if result_content and ("Ï†ÑÏ≤¥ Ï†êÏàò" in result_content or "CBIL" in result_content):
                    print("üéâ SUCCESS: Analysis result found!")
                    break
                elif result_content and "Î∂ÑÏÑù" in result_content and len(result_content) > 20:
                    print("‚úÖ Analysis completed (basic result)")
                    break
            
            # Final check and screenshot
            final_result = page.text_content("#analysis-result")
            print(f"üìä Final result: {final_result}")
            
            page.screenshot(path="final_analysis_test.png")
            
            # Also check the network tab for API calls
            page.evaluate("""
                console.log('=== CHECKING API RESPONSE ===');
                fetch('/api/analyze/text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'analysis-api-key-prod-2025'
                    },
                    body: JSON.stringify({
                        text: 'ÌÖåÏä§Ìä∏ Î¨∏Ïû•ÏûÖÎãàÎã§',
                        framework: 'cbil'
                    })
                }).then(r => r.json()).then(data => {
                    console.log('API Response:', JSON.stringify(data, null, 2));
                }).catch(e => {
                    console.error('API Error:', e);
                });
            """)
            
            time.sleep(3)  # Wait for API test result
            
            if final_result and len(final_result) > 10:
                return True
            else:
                return False
                
        except Exception as e:
            print(f"‚ùå Error: {e}")
            return False
            
        finally:
            time.sleep(5)
            browser.close()

if __name__ == "__main__":
    success = final_test()
    print(f"\nüèÅ Final result: {'SUCCESS' if success else 'NEEDS DEBUGGING'}")